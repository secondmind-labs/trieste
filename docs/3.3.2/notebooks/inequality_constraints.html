
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Inequality constraints &#8212; trieste 3.3.2 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/inequality_constraints';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://secondmind-labs.github.io/trieste/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '3.3.2';
        </script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Explicit constraints" href="explicit_constraints.html" />
    <link rel="prev" title="Thompson sampling" href="thompson_sampling.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../index.html">
                        Trieste
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../autoapi/trieste/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../bibliography.html">
                        Bibliography
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button type="button" class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle" data-bs-toggle="dropdown">
      3.3.2  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div class="version-switcher__menu dropdown-menu list-group-flush py-0">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/secondmind-labs/trieste" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../index.html">
                        Trieste
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../autoapi/trieste/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../bibliography.html">
                        Bibliography
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button type="button" class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle" data-bs-toggle="dropdown">
      3.3.2  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div class="version-switcher__menu dropdown-menu list-group-flush py-0">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/secondmind-labs/trieste" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="expected_improvement.html">Introduction to Bayesian optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch_optimization.html">Batch Bayesian optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="thompson_sampling.html">Thompson sampling</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Inequality constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="explicit_constraints.html">Explicit constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="failure_ego.html">Failure regions</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_objective_ehvi.html">Multi-objective optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_gaussian_processes.html">Deep Gaussian processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_ensembles.html">Deep ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="active_learning.html">Active learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="active_learning_for_binary_classification.html">Active learning for binary classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="feasible_sets.html">Active learning of feasibility regions</a></li>
<li class="toctree-l1"><a class="reference internal" href="openai_gym_lunar_lander.html">OpenAI Gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="scalable_thompson_sampling_using_sparse_gaussian_processes.html">Scalable Thompson sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="qhsri-tutorial.html">Batching with Sharpe Ratio</a></li>
<li class="toctree-l1"><a class="reference internal" href="multifidelity_modelling.html">Multifidelity modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="rembo.html">High-dimensional Bayesian optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="trust_region.html">Trust region Bayesian optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixed_search_spaces.html">Mixed search spaces</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ask_tell_optimization.html">Ask-Tell optimization interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_transformation.html">Data transformation</a></li>

<li class="toctree-l1"><a class="reference internal" href="recovering_from_errors.html">Recovering from errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="asynchronous_greedy_multiprocessing.html">Asynchronous Bayesian Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualizing_with_tensorboard.html">Visualizing with Tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_overview.html">An overview of Trieste types</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../tutorials.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Inequality constraints</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="Inequality-constraints">
<h1>Inequality constraints<a class="headerlink" href="#Inequality-constraints" title="Permalink to this heading">#</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1799</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">1799</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="The-problem">
<h2>The problem<a class="headerlink" href="#The-problem" title="Permalink to this heading">#</a></h2>
<p>In this tutorial, we replicate one of the results of <span id="id1">[<a class="reference internal" href="../bibliography.html#id6" title="Jacob Gardner, Matt Kusner, Zhixiang, Kilian Weinberger, and John Cunningham. Bayesian optimization with inequality constraints. In Proceedings of the 31st International Conference on Machine Learning, volume 32 of Proceedings of Machine Learning Research. PMLR, 22–24 Jun 2014. URL: http://proceedings.mlr.press/v32/gardner14.html.">GKZ+14</a>]</span>, specifically their synthetic experiment “simulation 1”, which consists of an objective function with a single constraint, defined over a two-dimensional input domain. We’ll start by defining the problem parameters. The constraint is satisfied when <code class="docutils literal notranslate"><span class="pre">constraint(input_data)</span> <span class="pre">&lt;=</span> <span class="pre">threshold</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trieste.space</span> <span class="kn">import</span> <span class="n">Box</span>


<span class="k">class</span> <span class="nc">Sim</span><span class="p">:</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">constraint</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>


<span class="n">search_space</span> <span class="o">=</span> <span class="n">Box</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>The objective and constraint functions are accessible as methods on the <code class="docutils literal notranslate"><span class="pre">Sim</span></code> class. Let’s visualise these functions, as well as the constrained objective. We get the constrained objective by masking out regions where the constraint function is above the threshold.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">trieste</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">trieste.experimental.plotting</span> <span class="kn">import</span> <span class="n">plot_objective_and_constraints</span>

<span class="n">plot_objective_and_constraints</span><span class="p">(</span><span class="n">search_space</span><span class="p">,</span> <span class="n">Sim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_inequality_constraints_5_0.png" src="../_images/notebooks_inequality_constraints_5_0.png" />
</div>
</div>
<p>We’ll make an observer that outputs both the objective and constraint data. Since the observer is outputting multiple datasets, we have to label them so that the optimization process knows which is which.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trieste.data</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="n">OBJECTIVE</span> <span class="o">=</span> <span class="s2">&quot;OBJECTIVE&quot;</span>
<span class="n">CONSTRAINT</span> <span class="o">=</span> <span class="s2">&quot;CONSTRAINT&quot;</span>


<span class="k">def</span> <span class="nf">observer</span><span class="p">(</span><span class="n">query_points</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">OBJECTIVE</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">query_points</span><span class="p">,</span> <span class="n">Sim</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span><span class="n">query_points</span><span class="p">)),</span>
        <span class="n">CONSTRAINT</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">query_points</span><span class="p">,</span> <span class="n">Sim</span><span class="o">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">query_points</span><span class="p">)),</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<p>Let’s randomly sample some initial data from the observer …</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_initial_points</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">initial_data</span> <span class="o">=</span> <span class="n">observer</span><span class="p">(</span><span class="n">search_space</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_initial_points</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>… and visualise those points on the constrained objective. Note how the generated data is labelled, like the observer.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trieste.experimental.plotting</span> <span class="kn">import</span> <span class="n">plot_init_query_points</span>

<span class="n">plot_init_query_points</span><span class="p">(</span>
    <span class="n">search_space</span><span class="p">,</span>
    <span class="n">Sim</span><span class="p">,</span>
    <span class="n">initial_data</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
    <span class="n">initial_data</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_inequality_constraints_11_0.png" src="../_images/notebooks_inequality_constraints_11_0.png" />
</div>
</div>
</section>
<section id="Modelling-the-two-functions">
<h2>Modelling the two functions<a class="headerlink" href="#Modelling-the-two-functions" title="Permalink to this heading">#</a></h2>
<p>We’ll model the objective and constraint data with their own Gaussian process regression model, as implemented in GPflow. The GPflow models cannot be used directly in our Bayesian optimization routines, so we build a GPflow’s <code class="docutils literal notranslate"><span class="pre">GPR</span></code> model using Trieste’s convenient model build function <code class="docutils literal notranslate"><span class="pre">build_gpr</span></code> and pass it to the <code class="docutils literal notranslate"><span class="pre">GaussianProcessRegression</span></code> wrapper. Note that we set the likelihood variance to a small number because we are dealing with a noise-free problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trieste.models.gpflow</span> <span class="kn">import</span> <span class="n">build_gpr</span><span class="p">,</span> <span class="n">GaussianProcessRegression</span>


<span class="k">def</span> <span class="nf">create_bo_model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">gpr</span> <span class="o">=</span> <span class="n">build_gpr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">search_space</span><span class="p">,</span> <span class="n">likelihood_variance</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">GaussianProcessRegression</span><span class="p">(</span><span class="n">gpr</span><span class="p">)</span>


<span class="n">initial_models</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">map_values</span><span class="p">(</span><span class="n">create_bo_model</span><span class="p">,</span> <span class="n">initial_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-the-acquisition-process">
<h2>Define the acquisition process<a class="headerlink" href="#Define-the-acquisition-process" title="Permalink to this heading">#</a></h2>
<p>We can construct the <em>expected constrained improvement</em> acquisition function defined in <span id="id2">[<a class="reference internal" href="../bibliography.html#id6" title="Jacob Gardner, Matt Kusner, Zhixiang, Kilian Weinberger, and John Cunningham. Bayesian optimization with inequality constraints. In Proceedings of the 31st International Conference on Machine Learning, volume 32 of Proceedings of Machine Learning Research. PMLR, 22–24 Jun 2014. URL: http://proceedings.mlr.press/v32/gardner14.html.">GKZ+14</a>]</span>, where they use the probability of feasibility with respect to the constraint model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trieste.acquisition.rule</span> <span class="kn">import</span> <span class="n">EfficientGlobalOptimization</span>

<span class="n">pof</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">acquisition</span><span class="o">.</span><span class="n">ProbabilityOfFeasibility</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">Sim</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
<span class="n">eci</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">acquisition</span><span class="o">.</span><span class="n">ExpectedConstrainedImprovement</span><span class="p">(</span>
    <span class="n">OBJECTIVE</span><span class="p">,</span> <span class="n">pof</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">CONSTRAINT</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">rule</span> <span class="o">=</span> <span class="n">EfficientGlobalOptimization</span><span class="p">(</span><span class="n">eci</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</section>
<section id="Run-the-optimization-loop">
<h2>Run the optimization loop<a class="headerlink" href="#Run-the-optimization-loop" title="Permalink to this heading">#</a></h2>
<p>We can now run the optimization loop. We obtain the final objective and constraint data using <code class="docutils literal notranslate"><span class="pre">.try_get_final_datasets()</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_steps</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">bo</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">bayesian_optimizer</span><span class="o">.</span><span class="n">BayesianOptimizer</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">search_space</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">bo</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
    <span class="n">num_steps</span><span class="p">,</span> <span class="n">initial_data</span><span class="p">,</span> <span class="n">initial_models</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">track_state</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">try_get_final_datasets</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING:tensorflow:5 out of the last 5 calls to &lt;function probability_below_threshold.__call__ at 0x7f5b003f1ab0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
WARNING:tensorflow:6 out of the last 6 calls to &lt;function probability_below_threshold.__call__ at 0x7f5b003f1ab0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
Optimization completed without errors
</pre></div></div>
</div>
<p>To conclude this section, we visualise the resulting data. Orange dots show the new points queried during optimization. Notice the concentration of these points in regions near the local minima.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">constraint_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span>
<span class="n">new_query_points</span> <span class="o">=</span> <span class="n">constraint_data</span><span class="o">.</span><span class="n">query_points</span><span class="p">[</span><span class="o">-</span><span class="n">num_steps</span><span class="p">:]</span>
<span class="n">new_observations</span> <span class="o">=</span> <span class="n">constraint_data</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="o">-</span><span class="n">num_steps</span><span class="p">:]</span>
<span class="n">new_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_query_points</span><span class="p">,</span> <span class="n">new_observations</span><span class="p">)</span>

<span class="n">plot_init_query_points</span><span class="p">(</span>
    <span class="n">search_space</span><span class="p">,</span>
    <span class="n">Sim</span><span class="p">,</span>
    <span class="n">initial_data</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
    <span class="n">initial_data</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
    <span class="n">new_data</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_inequality_constraints_19_0.png" src="../_images/notebooks_inequality_constraints_19_0.png" />
</div>
</div>
</section>
<section id="Batch-sequential-strategy">
<h2>Batch-sequential strategy<a class="headerlink" href="#Batch-sequential-strategy" title="Permalink to this heading">#</a></h2>
<p>We’ll now look at a batch-sequential approach to the same problem. Sometimes it’s beneficial to query several points at a time instead of one. The acquisition function we used earlier, built by <code class="docutils literal notranslate"><span class="pre">ExpectedConstrainedImprovement</span></code>, only supports a batch size of 1, so we’ll need a new acquisition function builder for larger batch sizes. We can implement this using the reparametrization trick with the Monte-Carlo sampler <code class="docutils literal notranslate"><span class="pre">BatchReparametrizationSampler</span></code>. Note that when we do this, we must
initialise the sampler <em>outside</em> the acquisition function (here <code class="docutils literal notranslate"><span class="pre">batch_efi</span></code>). This is crucial: a given instance of a sampler produces repeatable, continuous samples, and we can use this to create a repeatable continuous acquisition function. Using a new sampler on each call would not result in a repeatable continuous acquisition function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BatchExpectedConstrainedImprovement</span><span class="p">(</span>
    <span class="n">trieste</span><span class="o">.</span><span class="n">acquisition</span><span class="o">.</span><span class="n">AcquisitionFunctionBuilder</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span> <span class="o">=</span> <span class="n">threshold</span>

    <span class="k">def</span> <span class="nf">prepare_acquisition_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">datasets</span><span class="p">):</span>
        <span class="n">objective_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span>
        <span class="n">objective_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span>

        <span class="n">samplers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tag</span><span class="p">:</span> <span class="n">trieste</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">gpflow</span><span class="o">.</span><span class="n">BatchReparametrizationSampler</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sample_size</span><span class="p">,</span> <span class="n">model</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">pf</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">acquisition</span><span class="o">.</span><span class="n">probability_below_threshold</span><span class="p">(</span>
            <span class="n">models</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span>
        <span class="p">)(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">objective_dataset</span><span class="o">.</span><span class="n">query_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">is_feasible</span> <span class="o">=</span> <span class="n">pf</span> <span class="o">&gt;=</span> <span class="mf">0.5</span>

        <span class="n">mean</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">objective_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">objective_dataset</span><span class="o">.</span><span class="n">query_points</span><span class="p">)</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">is_feasible</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">batch_efi</span><span class="p">(</span><span class="n">at</span><span class="p">):</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tag</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">sampler</span> <span class="ow">in</span> <span class="n">samplers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">feasible_mask</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span>  <span class="c1"># [N, S, B]</span>
            <span class="n">improvement</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">feasible_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">eta</span> <span class="o">-</span> <span class="n">samples</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">0.0</span>
            <span class="p">)</span>  <span class="c1"># [N, S, B]</span>
            <span class="n">batch_improvement</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">improvement</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [N, S]</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
                <span class="n">batch_improvement</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>  <span class="c1"># [N, 1]</span>

        <span class="k">return</span> <span class="n">batch_efi</span>


<span class="n">num_query_points</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">batch_eci</span> <span class="o">=</span> <span class="n">BatchExpectedConstrainedImprovement</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">Sim</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
<span class="n">batch_rule</span> <span class="o">=</span> <span class="n">EfficientGlobalOptimization</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
    <span class="n">batch_eci</span><span class="p">,</span> <span class="n">num_query_points</span><span class="o">=</span><span class="n">num_query_points</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can now run the BO loop as before; note that here we also query twenty points, but in five batches of four points.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_models</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">map_values</span><span class="p">(</span><span class="n">create_bo_model</span><span class="p">,</span> <span class="n">initial_data</span><span class="p">)</span>

<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">batch_data</span> <span class="o">=</span> <span class="n">bo</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
    <span class="n">num_steps</span><span class="p">,</span> <span class="n">initial_data</span><span class="p">,</span> <span class="n">initial_models</span><span class="p">,</span> <span class="n">batch_rule</span><span class="p">,</span> <span class="n">track_state</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">try_get_final_datasets</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimization completed without errors
</pre></div></div>
</div>
<p>We visualise the resulting data as before.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_constraint_data</span> <span class="o">=</span> <span class="n">batch_data</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span>
<span class="n">new_batch_data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">batch_constraint_data</span><span class="o">.</span><span class="n">query_points</span><span class="p">[</span><span class="o">-</span><span class="n">num_query_points</span> <span class="o">*</span> <span class="n">num_steps</span> <span class="p">:],</span>
    <span class="n">batch_constraint_data</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="o">-</span><span class="n">num_query_points</span> <span class="o">*</span> <span class="n">num_steps</span> <span class="p">:],</span>
<span class="p">)</span>

<span class="n">plot_init_query_points</span><span class="p">(</span>
    <span class="n">search_space</span><span class="p">,</span>
    <span class="n">Sim</span><span class="p">,</span>
    <span class="n">initial_data</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
    <span class="n">initial_data</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
    <span class="n">new_batch_data</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_inequality_constraints_25_0.png" src="../_images/notebooks_inequality_constraints_25_0.png" />
</div>
</div>
<p>Finally, we compare the regret from the non-batch strategy (left panel) to the regret from the batch strategy (right panel). In the following plots each marker represents a query point. The x-axis is the index of the query point (where the first queried point has index 0), and the y-axis is the observed value. The vertical blue line denotes the end of initialisation/start of optimisation. Green points satisfy the constraint, red points do not.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trieste.experimental.plotting</span> <span class="kn">import</span> <span class="n">plot_regret</span>

<span class="n">mask_fail</span> <span class="o">=</span> <span class="n">constraint_data</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Sim</span><span class="o">.</span><span class="n">threshold</span>
<span class="n">batch_mask_fail</span> <span class="o">=</span> <span class="n">batch_constraint_data</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Sim</span><span class="o">.</span><span class="n">threshold</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
<span class="n">plot_regret</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span><span class="p">,</span>
    <span class="n">mask_fail</span><span class="o">=</span><span class="n">mask_fail</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">plot_regret</span><span class="p">(</span>
    <span class="n">batch_data</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span><span class="p">,</span>
    <span class="n">mask_fail</span><span class="o">=</span><span class="n">batch_mask_fail</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_inequality_constraints_27_0.png" src="../_images/notebooks_inequality_constraints_27_0.png" />
</div>
</div>
</section>
<section id="Constrained-optimization-with-more-than-one-constraint">
<h2>Constrained optimization with more than one constraint<a class="headerlink" href="#Constrained-optimization-with-more-than-one-constraint" title="Permalink to this heading">#</a></h2>
<p>We’ll now show how to use a reducer to combine multiple constraints. The new problem <code class="docutils literal notranslate"><span class="pre">Sim2</span></code> inherits from the previous one its objective and first constraint, but also adds a second constraint. We start by adding an output to our observer, and creating a set of three models.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Sim2</span><span class="p">(</span><span class="n">Sim</span><span class="p">):</span>
    <span class="n">threshold2</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">constraint2</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>


<span class="n">CONSTRAINT2</span> <span class="o">=</span> <span class="s2">&quot;CONSTRAINT2&quot;</span>


<span class="k">def</span> <span class="nf">observer_two_constraints</span><span class="p">(</span><span class="n">query_points</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">OBJECTIVE</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">query_points</span><span class="p">,</span> <span class="n">Sim2</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span><span class="n">query_points</span><span class="p">)),</span>
        <span class="n">CONSTRAINT</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">query_points</span><span class="p">,</span> <span class="n">Sim2</span><span class="o">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">query_points</span><span class="p">)),</span>
        <span class="n">CONSTRAINT2</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">query_points</span><span class="p">,</span> <span class="n">Sim2</span><span class="o">.</span><span class="n">constraint2</span><span class="p">(</span><span class="n">query_points</span><span class="p">)),</span>
    <span class="p">}</span>


<span class="n">num_initial_points</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">initial_data</span> <span class="o">=</span> <span class="n">observer_two_constraints</span><span class="p">(</span><span class="n">search_space</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_initial_points</span><span class="p">))</span>
<span class="n">initial_models</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">map_values</span><span class="p">(</span><span class="n">create_bo_model</span><span class="p">,</span> <span class="n">initial_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now, the probability that the two constraints are feasible is the product of the two feasibilities. Hence, we combine the two <code class="docutils literal notranslate"><span class="pre">ProbabilityOfFeasibility</span></code> functions into one quantity by using a <code class="docutils literal notranslate"><span class="pre">Product</span></code> <code class="docutils literal notranslate"><span class="pre">Reducer</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trieste.acquisition.combination</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="n">pof1</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">acquisition</span><span class="o">.</span><span class="n">ProbabilityOfFeasibility</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">Sim2</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
<span class="n">pof2</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">acquisition</span><span class="o">.</span><span class="n">ProbabilityOfFeasibility</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">Sim2</span><span class="o">.</span><span class="n">threshold2</span><span class="p">)</span>
<span class="n">pof</span> <span class="o">=</span> <span class="n">Product</span><span class="p">(</span><span class="n">pof1</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">CONSTRAINT</span><span class="p">),</span> <span class="n">pof2</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">CONSTRAINT2</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<p>We can now run the BO loop as before, and visualize the results:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eci</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">acquisition</span><span class="o">.</span><span class="n">ExpectedConstrainedImprovement</span><span class="p">(</span><span class="n">OBJECTIVE</span><span class="p">,</span> <span class="n">pof</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<span class="n">rule</span> <span class="o">=</span> <span class="n">EfficientGlobalOptimization</span><span class="p">(</span><span class="n">eci</span><span class="p">)</span>

<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">bo</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">bayesian_optimizer</span><span class="o">.</span><span class="n">BayesianOptimizer</span><span class="p">(</span>
    <span class="n">observer_two_constraints</span><span class="p">,</span> <span class="n">search_space</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">bo</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
    <span class="n">num_steps</span><span class="p">,</span> <span class="n">initial_data</span><span class="p">,</span> <span class="n">initial_models</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">track_state</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">try_get_final_datasets</span><span class="p">()</span>

<span class="n">constraint_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span>
<span class="n">new_query_points</span> <span class="o">=</span> <span class="n">constraint_data</span><span class="o">.</span><span class="n">query_points</span><span class="p">[</span><span class="o">-</span><span class="n">num_steps</span><span class="p">:]</span>
<span class="n">new_observations</span> <span class="o">=</span> <span class="n">constraint_data</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="o">-</span><span class="n">num_steps</span><span class="p">:]</span>
<span class="n">new_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_query_points</span><span class="p">,</span> <span class="n">new_observations</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">masked_objective</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">mask_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
        <span class="n">Sim2</span><span class="o">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Sim2</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
        <span class="n">Sim2</span><span class="o">.</span><span class="n">constraint2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Sim2</span><span class="o">.</span><span class="n">threshold2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Sim2</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">y</span><span class="p">[</span><span class="n">mask_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>


<span class="n">mask_fail1</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Sim2</span><span class="o">.</span><span class="n">threshold</span>
<span class="p">)</span>
<span class="n">mask_fail2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="n">CONSTRAINT2</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="o">&gt;</span> <span class="n">Sim2</span><span class="o">.</span><span class="n">threshold2</span>
<span class="p">)</span>
<span class="n">mask_fail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask_fail1</span><span class="p">,</span> <span class="n">mask_fail2</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">trieste.experimental.plotting</span> <span class="kn">import</span> <span class="n">plot_function_2d</span><span class="p">,</span> <span class="n">plot_bo_points</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_function_2d</span><span class="p">(</span>
    <span class="n">masked_objective</span><span class="p">,</span>
    <span class="n">search_space</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span>
    <span class="n">search_space</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span>
    <span class="n">contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plot_bo_points</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span><span class="o">.</span><span class="n">query_points</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span><span class="p">,</span>
    <span class="n">mask_fail</span><span class="o">=</span><span class="n">mask_fail</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimization completed without errors
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_inequality_constraints_33_1.png" src="../_images/notebooks_inequality_constraints_33_1.png" />
</div>
</div>
</section>
<section id="LICENSE">
<h2>LICENSE<a class="headerlink" href="#LICENSE" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://github.com/secondmind-labs/trieste/blob/develop/LICENSE">Apache License 2.0</a></p>
</section>
</section>


                </article>
              
              
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#The-problem">The problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Modelling-the-two-functions">Modelling the two functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Define-the-acquisition-process">Define the acquisition process</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Run-the-optimization-loop">Run the optimization loop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Batch-sequential-strategy">Batch-sequential strategy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Constrained-optimization-with-more-than-one-constraint">Constrained optimization with more than one constraint</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#LICENSE">LICENSE</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright Copyright 2020 The Trieste Contributors

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.1.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>
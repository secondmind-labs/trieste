
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Multi-objective optimization &#8212; trieste 3.3.2 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/multi_objective_ehvi';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://secondmind-labs.github.io/trieste/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '3.3.2';
        </script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Deep Gaussian processes" href="deep_gaussian_processes.html" />
    <link rel="prev" title="Failure regions" href="failure_ego.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../index.html">
                        Trieste
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../autoapi/trieste/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../bibliography.html">
                        Bibliography
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button type="button" class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle" data-bs-toggle="dropdown">
      3.3.2  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div class="version-switcher__menu dropdown-menu list-group-flush py-0">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/secondmind-labs/trieste" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../index.html">
                        Trieste
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../autoapi/trieste/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../bibliography.html">
                        Bibliography
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button type="button" class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle" data-bs-toggle="dropdown">
      3.3.2  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div class="version-switcher__menu dropdown-menu list-group-flush py-0">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/secondmind-labs/trieste" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="expected_improvement.html">Introduction to Bayesian optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch_optimization.html">Batch Bayesian optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="thompson_sampling.html">Thompson sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="inequality_constraints.html">Inequality constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="explicit_constraints.html">Explicit constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="failure_ego.html">Failure regions</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Multi-objective optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_gaussian_processes.html">Deep Gaussian processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_ensembles.html">Deep ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="active_learning.html">Active learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="active_learning_for_binary_classification.html">Active learning for binary classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="feasible_sets.html">Active learning of feasibility regions</a></li>
<li class="toctree-l1"><a class="reference internal" href="openai_gym_lunar_lander.html">OpenAI Gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="scalable_thompson_sampling_using_sparse_gaussian_processes.html">Scalable Thompson sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="qhsri-tutorial.html">Batching with Sharpe Ratio</a></li>
<li class="toctree-l1"><a class="reference internal" href="multifidelity_modelling.html">Multifidelity modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="rembo.html">High-dimensional Bayesian optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="trust_region.html">Trust region Bayesian optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixed_search_spaces.html">Mixed search spaces</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ask_tell_optimization.html">Ask-Tell optimization interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_transformation.html">Data transformation</a></li>

<li class="toctree-l1"><a class="reference internal" href="recovering_from_errors.html">Recovering from errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="asynchronous_greedy_multiprocessing.html">Asynchronous Bayesian Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualizing_with_tensorboard.html">Visualizing with Tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_overview.html">An overview of Trieste types</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../tutorials.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Multi-objective optimization</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="Multi-objective-optimization">
<h1>Multi-objective optimization<a class="headerlink" href="#Multi-objective-optimization" title="Permalink to this heading">#</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">gpflow</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">trieste.experimental.plotting</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">plot_bo_points</span><span class="p">,</span>
    <span class="n">plot_function_2d</span><span class="p">,</span>
    <span class="n">plot_mobo_history</span><span class="p">,</span>
    <span class="n">plot_mobo_points_in_obj_space</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">trieste</span>
<span class="kn">from</span> <span class="nn">trieste.acquisition.function</span> <span class="kn">import</span> <span class="n">ExpectedHypervolumeImprovement</span>
<span class="kn">from</span> <span class="nn">trieste.acquisition.rule</span> <span class="kn">import</span> <span class="n">EfficientGlobalOptimization</span>
<span class="kn">from</span> <span class="nn">trieste.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">trieste.models</span> <span class="kn">import</span> <span class="n">TrainableModelStack</span>
<span class="kn">from</span> <span class="nn">trieste.models.gpflow</span> <span class="kn">import</span> <span class="n">build_gpr</span><span class="p">,</span> <span class="n">GaussianProcessRegression</span>
<span class="kn">from</span> <span class="nn">trieste.space</span> <span class="kn">import</span> <span class="n">Box</span><span class="p">,</span> <span class="n">SearchSpace</span>
<span class="kn">from</span> <span class="nn">trieste.objectives.multi_objectives</span> <span class="kn">import</span> <span class="n">VLMOP2</span>
<span class="kn">from</span> <span class="nn">trieste.acquisition.multi_objective.pareto</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Pareto</span><span class="p">,</span>
    <span class="n">get_reference_point</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1793</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">1793</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Describe-the-problem">
<h2>Describe the problem<a class="headerlink" href="#Describe-the-problem" title="Permalink to this heading">#</a></h2>
<p>In this tutorial, we provide a multi-objective optimization example using the expected hypervolume improvement acquisition function. We consider the VLMOP2 problem — a synthetic benchmark problem with two objectives and input dimensionality of two. We start by defining the problem parameters.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vlmop2</span> <span class="o">=</span> <span class="n">VLMOP2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">observer</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">objectives</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">mk_observer</span><span class="p">(</span><span class="n">vlmop2</span><span class="o">.</span><span class="n">objective</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="n">maxs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">search_space</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="n">mins</span><span class="p">,</span> <span class="n">maxs</span><span class="p">)</span>
<span class="n">num_objective</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<p>Let’s randomly sample some initial data from the observer …</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_initial_points</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">initial_query_points</span> <span class="o">=</span> <span class="n">search_space</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_initial_points</span><span class="p">)</span>
<span class="n">initial_data</span> <span class="o">=</span> <span class="n">observer</span><span class="p">(</span><span class="n">initial_query_points</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>… and visualise the data across the design space: each figure contains the contour lines of each objective function.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_function_2d</span><span class="p">(</span>
    <span class="n">vlmop2</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
    <span class="n">mins</span><span class="p">,</span>
    <span class="n">maxs</span><span class="p">,</span>
    <span class="n">contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Obj 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Obj 2&quot;</span><span class="p">],</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;$X_1$&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;$X_2$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plot_bo_points</span><span class="p">(</span><span class="n">initial_query_points</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span><span class="p">)</span>
<span class="n">plot_bo_points</span><span class="p">(</span><span class="n">initial_query_points</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages/matplotlib/_mathtext.py:1880: UserWarning: warn_name_set_on_empty_Forward: setting results name &#39;sym&#39; on Forward expression that has no contained expression
  - p.placeable(&#34;sym&#34;))
/opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages/matplotlib/_mathtext.py:1885: UserWarning: warn_ungrouped_named_tokens_in_collection: setting results name &#39;name&#39; on ZeroOrMore expression collides with &#39;name&#39; on contained expression
  &#34;{&#34; + ZeroOrMore(p.simple | p.unknown_symbol)(&#34;name&#34;) + &#34;}&#34;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_9_1.png" src="../_images/notebooks_multi_objective_ehvi_9_1.png" />
</div>
</div>
<p>… and in the objective space. The <code class="docutils literal notranslate"><span class="pre">plot_mobo_points_in_obj_space</span></code> will automatically search for non-dominated points and colours them in purple.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_mobo_points_in_obj_space</span><span class="p">(</span><span class="n">initial_data</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_11_0.png" src="../_images/notebooks_multi_objective_ehvi_11_0.png" />
</div>
</div>
</section>
<section id="Modelling-the-two-functions">
<h2>Modelling the two functions<a class="headerlink" href="#Modelling-the-two-functions" title="Permalink to this heading">#</a></h2>
<p>In this example we model the two objective functions individually with their own Gaussian process models, for problems where the objective functions are similar it may make sense to build a joint model.</p>
<p>We use a model wrapper: <code class="docutils literal notranslate"><span class="pre">TrainableModelStack</span></code> to stack these two independent GPs into a single model working as an (independent) multi-output model. Note that we set the likelihood variance to a small number because we are dealing with a noise-free problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_stacked_independent_objectives_model</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">num_output</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">search_space</span><span class="p">:</span> <span class="n">SearchSpace</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainableModelStack</span><span class="p">:</span>
    <span class="n">gprs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_output</span><span class="p">):</span>
        <span class="n">single_obj_data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">query_points</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">gpr</span> <span class="o">=</span> <span class="n">build_gpr</span><span class="p">(</span><span class="n">single_obj_data</span><span class="p">,</span> <span class="n">search_space</span><span class="p">,</span> <span class="n">likelihood_variance</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
        <span class="n">gprs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">GaussianProcessRegression</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">TrainableModelStack</span><span class="p">(</span><span class="o">*</span><span class="n">gprs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">build_stacked_independent_objectives_model</span><span class="p">(</span>
    <span class="n">initial_data</span><span class="p">,</span> <span class="n">num_objective</span><span class="p">,</span> <span class="n">search_space</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-the-acquisition-function">
<h2>Define the acquisition function<a class="headerlink" href="#Define-the-acquisition-function" title="Permalink to this heading">#</a></h2>
<p>Here we utilize the <a class="reference external" href="https://link.springer.com/article/10.1007/s10898-019-00798-7">EHVI</a>: <code class="docutils literal notranslate"><span class="pre">ExpectedHypervolumeImprovement</span></code> acquisition function:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ehvi</span> <span class="o">=</span> <span class="n">ExpectedHypervolumeImprovement</span><span class="p">()</span>
<span class="n">rule</span><span class="p">:</span> <span class="n">EfficientGlobalOptimization</span> <span class="o">=</span> <span class="n">EfficientGlobalOptimization</span><span class="p">(</span><span class="n">builder</span><span class="o">=</span><span class="n">ehvi</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Run-the-optimization-loop">
<h2>Run the optimization loop<a class="headerlink" href="#Run-the-optimization-loop" title="Permalink to this heading">#</a></h2>
<p>We can now run the optimization loop</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_steps</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">bo</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">bayesian_optimizer</span><span class="o">.</span><span class="n">BayesianOptimizer</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">search_space</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">bo</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">initial_data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">acquisition_rule</span><span class="o">=</span><span class="n">rule</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimization completed without errors
</pre></div></div>
</div>
<p>To conclude, we visualize the queried data across the design space. We represent the initial points as crosses and the points obtained by our optimization loop as dots.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">try_get_final_dataset</span><span class="p">()</span>
<span class="n">data_query_points</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">query_points</span>
<span class="n">data_observations</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">observations</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_function_2d</span><span class="p">(</span>
    <span class="n">vlmop2</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
    <span class="n">mins</span><span class="p">,</span>
    <span class="n">maxs</span><span class="p">,</span>
    <span class="n">contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Obj 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Obj 2&quot;</span><span class="p">],</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;$X_1$&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;$X_2$&quot;</span><span class="p">,</span>
    <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plot_bo_points</span><span class="p">(</span><span class="n">data_query_points</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span><span class="p">)</span>
<span class="n">plot_bo_points</span><span class="p">(</span><span class="n">data_query_points</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_20_0.png" src="../_images/notebooks_multi_objective_ehvi_20_0.png" />
</div>
</div>
<p>Visualize in objective space. Purple dots denote the non-dominated points.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_mobo_points_in_obj_space</span><span class="p">(</span><span class="n">data_observations</span><span class="p">,</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_22_0.png" src="../_images/notebooks_multi_objective_ehvi_22_0.png" />
</div>
</div>
<p>We can also visualize how a performance metric evolved with respect to the number of BO iterations. First, we need to define a performance metric. Many metrics have been considered for multi-objective optimization. Here, we use the log hypervolume difference, defined as the difference between the hypervolume of the actual Pareto front and the hypervolume of the approximate Pareto front based on the bo-obtained data.</p>
<div class="math notranslate nohighlight">
\[log_{10}\ \text{HV}_{\text{diff}} = log_{10}(\text{HV}_{\text{actual}} - \text{HV}_{\text{bo-obtained}})\]</div>
<p>First we need to calculate the <span class="math notranslate nohighlight">\(\text{HV}_{\text{actual}}\)</span> based on the actual Pareto front. For some multi-objective synthetic functions like VLMOP2, the actual Pareto front has a clear definition, thus we could use <code class="docutils literal notranslate"><span class="pre">gen_pareto_optimal_points</span></code> to near uniformly sample on the actual Pareto front. And use these generated Pareto optimal points to (approximately) calculate the hypervolume of the actual Pareto frontier:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">actual_pf</span> <span class="o">=</span> <span class="n">vlmop2</span><span class="o">.</span><span class="n">gen_pareto_optimal_points</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># gen 100 pf points</span>
<span class="n">ref_point</span> <span class="o">=</span> <span class="n">get_reference_point</span><span class="p">(</span><span class="n">data_observations</span><span class="p">)</span>
<span class="n">idea_hv</span> <span class="o">=</span> <span class="n">Pareto</span><span class="p">(</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">actual_pf</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_observations</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">hypervolume_indicator</span><span class="p">(</span><span class="n">ref_point</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then we define the metric function:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">log_hv</span><span class="p">(</span><span class="n">observations</span><span class="p">):</span>
    <span class="n">obs_hv</span> <span class="o">=</span> <span class="n">Pareto</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span><span class="o">.</span><span class="n">hypervolume_indicator</span><span class="p">(</span><span class="n">ref_point</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">idea_hv</span> <span class="o">-</span> <span class="n">obs_hv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, we can plot the convergence of our performance metric over the course of the optimization. The blue vertical line in the figure denotes the time after which BO starts.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_mobo_history</span><span class="p">(</span>
    <span class="n">data_observations</span><span class="p">,</span> <span class="n">log_hv</span><span class="p">,</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iterations&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;log HV difference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_30_0.png" src="../_images/notebooks_multi_objective_ehvi_30_0.png" />
</div>
</div>
</section>
<section id="Batch-multi-objective-optimization">
<h2>Batch multi-objective optimization<a class="headerlink" href="#Batch-multi-objective-optimization" title="Permalink to this heading">#</a></h2>
<p>EHVI can be extended to the case of batches (i.e. query several points at a time) using the <code class="docutils literal notranslate"><span class="pre">Fantasizer</span></code>. <code class="docutils literal notranslate"><span class="pre">Fantasizer</span></code> works by greedily optimising a base acquisition function, then “fantasizing” the observations at the chosen query points and updating the predictive equations of the models as if the fantasized data was added to the models. The only changes that need to be done here are to wrap the <code class="docutils literal notranslate"><span class="pre">ExpectedHypervolumeImprovement</span></code> in a <code class="docutils literal notranslate"><span class="pre">Fantasizer</span></code> object, and set the rule argument
<code class="docutils literal notranslate"><span class="pre">num_query_points</span></code> to a value greater than one. Here, we choose 10 batches of size 3, so the observation budget is the same as before.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">build_stacked_independent_objectives_model</span><span class="p">(</span>
    <span class="n">initial_data</span><span class="p">,</span> <span class="n">num_objective</span><span class="p">,</span> <span class="n">search_space</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">trieste.acquisition.function</span> <span class="kn">import</span> <span class="n">Fantasizer</span>

<span class="n">batch_ehvi</span> <span class="o">=</span> <span class="n">Fantasizer</span><span class="p">(</span><span class="n">ExpectedHypervolumeImprovement</span><span class="p">())</span>
<span class="n">batch_rule</span><span class="p">:</span> <span class="n">EfficientGlobalOptimization</span> <span class="o">=</span> <span class="n">EfficientGlobalOptimization</span><span class="p">(</span>
    <span class="n">builder</span><span class="o">=</span><span class="n">batch_ehvi</span><span class="p">,</span> <span class="n">num_query_points</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>
<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">bo</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">bayesian_optimizer</span><span class="o">.</span><span class="n">BayesianOptimizer</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">search_space</span><span class="p">)</span>
<span class="n">batch_result</span> <span class="o">=</span> <span class="n">bo</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
    <span class="n">num_steps</span><span class="p">,</span> <span class="n">initial_data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">acquisition_rule</span><span class="o">=</span><span class="n">batch_rule</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING:tensorflow:5 out of the last 283 calls to &lt;function expected_hv_improvement.__call__ at 0x7f9ae83005e0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
Optimization completed without errors
</pre></div></div>
</div>
<p>We can have a look at the results, as in the previous case. For this relatively simple problem, the greedy heuristic works quite well, and the performance is similar to the non-batch run.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">try_get_final_dataset</span><span class="p">()</span>
<span class="n">batch_data_query_points</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">query_points</span>
<span class="n">batch_data_observations</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">observations</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_function_2d</span><span class="p">(</span>
    <span class="n">vlmop2</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
    <span class="n">mins</span><span class="p">,</span>
    <span class="n">maxs</span><span class="p">,</span>
    <span class="n">contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Obj 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Obj 2&quot;</span><span class="p">],</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;$X_1$&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;$X_2$&quot;</span><span class="p">,</span>
    <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plot_bo_points</span><span class="p">(</span>
    <span class="n">batch_data_query_points</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span>
<span class="p">)</span>
<span class="n">plot_bo_points</span><span class="p">(</span>
    <span class="n">batch_data_query_points</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_mobo_points_in_obj_space</span><span class="p">(</span>
    <span class="n">batch_data_observations</span><span class="p">,</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_mobo_history</span><span class="p">(</span>
    <span class="n">batch_data_observations</span><span class="p">,</span> <span class="n">log_hv</span><span class="p">,</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iterations&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;log HV difference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_34_0.png" src="../_images/notebooks_multi_objective_ehvi_34_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_34_1.png" src="../_images/notebooks_multi_objective_ehvi_34_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_34_2.png" src="../_images/notebooks_multi_objective_ehvi_34_2.png" />
</div>
</div>
</section>
<section id="Multi-objective-optimization-with-constraints">
<h2>Multi-objective optimization with constraints<a class="headerlink" href="#Multi-objective-optimization-with-constraints" title="Permalink to this heading">#</a></h2>
<p>EHVI can be adapted to the case of constraints, as we show below. We start by defining a problem with the same objectives as above, but with an inequality constraint, and we define the corresponding <code class="docutils literal notranslate"><span class="pre">Observer</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Sim</span><span class="p">:</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.75</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">vlmop2</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">constraint</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>


<span class="n">OBJECTIVE</span> <span class="o">=</span> <span class="s2">&quot;OBJECTIVE&quot;</span>
<span class="n">CONSTRAINT</span> <span class="o">=</span> <span class="s2">&quot;CONSTRAINT&quot;</span>


<span class="k">def</span> <span class="nf">observer_cst</span><span class="p">(</span><span class="n">query_points</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">OBJECTIVE</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">query_points</span><span class="p">,</span> <span class="n">Sim</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span><span class="n">query_points</span><span class="p">)),</span>
        <span class="n">CONSTRAINT</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">query_points</span><span class="p">,</span> <span class="n">Sim</span><span class="o">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">query_points</span><span class="p">)),</span>
    <span class="p">}</span>


<span class="n">num_initial_points</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">initial_query_points</span> <span class="o">=</span> <span class="n">search_space</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_initial_points</span><span class="p">)</span>
<span class="n">initial_data_with_cst</span> <span class="o">=</span> <span class="n">observer_cst</span><span class="p">(</span><span class="n">initial_query_points</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>As previously, we visualise the data across the design space: each figure contains the contour lines of each objective function and in the objective space. The <code class="docutils literal notranslate"><span class="pre">plot_mobo_points_in_obj_space</span></code> will automatically search for non-dominated points and colours them in purple, and the points in red violate the constraint.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trieste.experimental.plotting</span> <span class="kn">import</span> <span class="n">plot_2obj_cst_query_points</span>

<span class="n">plot_2obj_cst_query_points</span><span class="p">(</span>
    <span class="n">search_space</span><span class="p">,</span>
    <span class="n">Sim</span><span class="p">,</span>
    <span class="n">initial_data_with_cst</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
    <span class="n">initial_data_with_cst</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">mask_fail</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">initial_data_with_cst</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Sim</span><span class="o">.</span><span class="n">threshold</span>
<span class="p">)</span>
<span class="n">plot_mobo_points_in_obj_space</span><span class="p">(</span>
    <span class="n">initial_data_with_cst</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="n">mask_fail</span><span class="o">=</span><span class="n">mask_fail</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_38_0.png" src="../_images/notebooks_multi_objective_ehvi_38_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_38_1.png" src="../_images/notebooks_multi_objective_ehvi_38_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_38_2.png" src="../_images/notebooks_multi_objective_ehvi_38_2.png" />
</div>
</div>
<p>We use the same model wrapper to build and stack the two GP models of the objective:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">objective_model</span> <span class="o">=</span> <span class="n">build_stacked_independent_objectives_model</span><span class="p">(</span>
    <span class="n">initial_data_with_cst</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">],</span> <span class="n">num_objective</span><span class="p">,</span> <span class="n">search_space</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We also create a single model of the constraint. Note that we set the likelihood variance to a small number because we are dealing with a noise-free problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gpflow_model</span> <span class="o">=</span> <span class="n">build_gpr</span><span class="p">(</span>
    <span class="n">initial_data_with_cst</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">],</span> <span class="n">search_space</span><span class="p">,</span> <span class="n">likelihood_variance</span><span class="o">=</span><span class="mf">1e-7</span>
<span class="p">)</span>
<span class="n">constraint_model</span> <span class="o">=</span> <span class="n">GaussianProcessRegression</span><span class="p">(</span><span class="n">gpflow_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We store both sets of models in a dictionary:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">{</span><span class="n">OBJECTIVE</span><span class="p">:</span> <span class="n">objective_model</span><span class="p">,</span> <span class="n">CONSTRAINT</span><span class="p">:</span> <span class="n">constraint_model</span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="Acquisition-function-for-multiple-objectives-and-constraints">
<h2>Acquisition function for multiple objectives and constraints<a class="headerlink" href="#Acquisition-function-for-multiple-objectives-and-constraints" title="Permalink to this heading">#</a></h2>
<p>We utilize the <code class="docutils literal notranslate"><span class="pre">ExpectedConstrainedHypervolumeImprovement</span></code> acquisition function, which is the product of EHVI (based on the feasible Pareto set) with the probability of feasibility:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trieste.acquisition.function</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExpectedConstrainedHypervolumeImprovement</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">pof</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">acquisition</span><span class="o">.</span><span class="n">ProbabilityOfFeasibility</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">Sim</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
<span class="n">echvi</span> <span class="o">=</span> <span class="n">ExpectedConstrainedHypervolumeImprovement</span><span class="p">(</span>
    <span class="n">OBJECTIVE</span><span class="p">,</span> <span class="n">pof</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">CONSTRAINT</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">rule</span> <span class="o">=</span> <span class="n">EfficientGlobalOptimization</span><span class="p">(</span><span class="n">builder</span><span class="o">=</span><span class="n">echvi</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can now run the optimization loop</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_steps</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">bo</span> <span class="o">=</span> <span class="n">trieste</span><span class="o">.</span><span class="n">bayesian_optimizer</span><span class="o">.</span><span class="n">BayesianOptimizer</span><span class="p">(</span><span class="n">observer_cst</span><span class="p">,</span> <span class="n">search_space</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">bo</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
    <span class="n">num_steps</span><span class="p">,</span> <span class="n">initial_data_with_cst</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">acquisition_rule</span><span class="o">=</span><span class="n">rule</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING:tensorflow:5 out of the last 5 calls to &lt;function probability_below_threshold.__call__ at 0x7f9abb8268c0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
WARNING:tensorflow:6 out of the last 6 calls to &lt;function probability_below_threshold.__call__ at 0x7f9abb8268c0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
Optimization completed without errors
</pre></div></div>
</div>
<p>As previously, we visualize the queried data across the design space. We represent the initial points as crosses and the points obtained by our optimization loop as dots.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">objective_dataset</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">final_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">OBJECTIVE</span><span class="p">]</span>
<span class="n">constraint_dataset</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">final_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">CONSTRAINT</span><span class="p">]</span>
<span class="n">data_query_points</span> <span class="o">=</span> <span class="n">objective_dataset</span><span class="o">.</span><span class="n">query_points</span>
<span class="n">data_observations</span> <span class="o">=</span> <span class="n">objective_dataset</span><span class="o">.</span><span class="n">observations</span>

<span class="n">plot_2obj_cst_query_points</span><span class="p">(</span>
    <span class="n">search_space</span><span class="p">,</span>
    <span class="n">Sim</span><span class="p">,</span>
    <span class="n">objective_dataset</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
    <span class="n">constraint_dataset</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_50_0.png" src="../_images/notebooks_multi_objective_ehvi_50_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_50_1.png" src="../_images/notebooks_multi_objective_ehvi_50_1.png" />
</div>
</div>
<p>Finally, we visualize them in the objective space. Purple dots denote the non-dominated points, and red ones the points that violate the constraint.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_fail</span> <span class="o">=</span> <span class="n">constraint_dataset</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Sim</span><span class="o">.</span><span class="n">threshold</span>
<span class="n">plot_mobo_points_in_obj_space</span><span class="p">(</span>
    <span class="n">data_observations</span><span class="p">,</span> <span class="n">num_init</span><span class="o">=</span><span class="n">num_initial_points</span><span class="p">,</span> <span class="n">mask_fail</span><span class="o">=</span><span class="n">mask_fail</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multi_objective_ehvi_52_0.png" src="../_images/notebooks_multi_objective_ehvi_52_0.png" />
</div>
</div>
</section>
<section id="LICENSE">
<h2>LICENSE<a class="headerlink" href="#LICENSE" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://github.com/secondmind-labs/trieste/blob/develop/LICENSE">Apache License 2.0</a></p>
</section>
</section>


                </article>
              
              
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Describe-the-problem">Describe the problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Modelling-the-two-functions">Modelling the two functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Define-the-acquisition-function">Define the acquisition function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Run-the-optimization-loop">Run the optimization loop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Batch-multi-objective-optimization">Batch multi-objective optimization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Multi-objective-optimization-with-constraints">Multi-objective optimization with constraints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Acquisition-function-for-multiple-objectives-and-constraints">Acquisition function for multiple objectives and constraints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#LICENSE">LICENSE</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright Copyright 2020 The Trieste Contributors

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.1.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>
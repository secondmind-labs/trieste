
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>trieste.bayesian_optimizer &#8212; trieste 3.3.3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/trieste/bayesian_optimizer';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://secondmind-labs.github.io/trieste/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '3.3.3';
        </script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../index.html">
                        Trieste
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../autoapi/trieste/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../bibliography.html">
                        Bibliography
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button type="button" class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle" data-bs-toggle="dropdown">
      3.3.3  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div class="version-switcher__menu dropdown-menu list-group-flush py-0">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/secondmind-labs/trieste" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../index.html">
                        Trieste
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../autoapi/trieste/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../bibliography.html">
                        Bibliography
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button type="button" class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle" data-bs-toggle="dropdown">
      3.3.3  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div class="version-switcher__menu dropdown-menu list-group-flush py-0">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/secondmind-labs/trieste" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">trieste.bayesian_optimizer</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for trieste.bayesian_optimizer</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2021 The Trieste Contributors</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the :class:`BayesianOptimizer` class, used to perform Bayesian optimization.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">ClassVar</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generic</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">absl</span>
<span class="kn">import</span> <span class="nn">dill</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span>

<span class="kn">from</span> <span class="nn">.acquisition.multi_objective</span> <span class="kn">import</span> <span class="n">non_dominated</span>
<span class="kn">from</span> <span class="nn">.models.utils</span> <span class="kn">import</span> <span class="n">optimize_model_and_save_result</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sns</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">.acquisition.rule</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AcquisitionRule</span><span class="p">,</span>
    <span class="n">EfficientGlobalOptimization</span><span class="p">,</span>
    <span class="n">LocalDatasetsAcquisitionRule</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.acquisition.utils</span> <span class="kn">import</span> <span class="n">with_local_datasets</span>
<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ProbabilisticModel</span><span class="p">,</span>
    <span class="n">SupportsCovarianceWithTopFidelity</span><span class="p">,</span>
    <span class="n">TrainableProbabilisticModel</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.objectives.utils</span> <span class="kn">import</span> <span class="n">mk_batch_observer</span>
<span class="kn">from</span> <span class="nn">.observer</span> <span class="kn">import</span> <span class="n">OBJECTIVE</span><span class="p">,</span> <span class="n">Observer</span>
<span class="kn">from</span> <span class="nn">.space</span> <span class="kn">import</span> <span class="n">SearchSpace</span>
<span class="kn">from</span> <span class="nn">.types</span> <span class="kn">import</span> <span class="n">State</span><span class="p">,</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">TensorType</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">Err</span><span class="p">,</span> <span class="n">Ok</span><span class="p">,</span> <span class="n">Result</span><span class="p">,</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">.utils.misc</span> <span class="kn">import</span> <span class="n">LocalizedTag</span><span class="p">,</span> <span class="n">get_value_for_tag</span><span class="p">,</span> <span class="n">ignoring_local_tags</span>

<div class="viewcode-block" id="StateType"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.StateType">[docs]</a><span class="n">StateType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;StateType&quot;</span><span class="p">)</span></div>
<span class="sd">&quot;&quot;&quot; Unbound type variable. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SearchSpaceType"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.SearchSpaceType">[docs]</a><span class="n">SearchSpaceType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;SearchSpaceType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">SearchSpace</span><span class="p">)</span></div>
<span class="sd">&quot;&quot;&quot; Type variable bound to :class:`SearchSpace`. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ProbabilisticModelType"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.ProbabilisticModelType">[docs]</a><span class="n">ProbabilisticModelType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span>
    <span class="s2">&quot;ProbabilisticModelType&quot;</span><span class="p">,</span>
    <span class="n">bound</span><span class="o">=</span><span class="n">ProbabilisticModel</span><span class="p">,</span>
    <span class="n">covariant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span></div>
<span class="sd">&quot;&quot;&quot; Covariant type variable bound to :class:`ProbabilisticModel`. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TrainableProbabilisticModelType"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.TrainableProbabilisticModelType">[docs]</a><span class="n">TrainableProbabilisticModelType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span>
    <span class="s2">&quot;TrainableProbabilisticModelType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">TrainableProbabilisticModel</span><span class="p">,</span> <span class="n">contravariant</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span></div>
<span class="sd">&quot;&quot;&quot; Contravariant type variable bound to :class:`TrainableProbabilisticModel`. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EarlyStopCallback"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.EarlyStopCallback">[docs]</a><span class="n">EarlyStopCallback</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span>
    <span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StateType</span><span class="p">]],</span>
    <span class="nb">bool</span><span class="p">,</span>
<span class="p">]</span></div>
<span class="sd">&quot;&quot;&quot; Early stop callback type, generic in the model and state types. &quot;&quot;&quot;</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="Record"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.Record">[docs]</a><span class="k">class</span> <span class="nc">Record</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Container to record the state of each step of the optimization process.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Record.datasets"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.Record.datasets">[docs]</a>    <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The known data from the observer. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Record.models"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.Record.models">[docs]</a>    <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The models over the :attr:`datasets`. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Record.acquisition_state"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.Record.acquisition_state">[docs]</a>    <span class="n">acquisition_state</span><span class="p">:</span> <span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The acquisition state. &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Record.dataset"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.Record.dataset">[docs]</a>    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The dataset when there is just one dataset.&quot;&quot;&quot;</span>
        <span class="c1"># Ignore local datasets.</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignoring_local_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected a single dataset, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Record.model"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.Record.model">[docs]</a>    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProbabilisticModelType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The model when there is just one dataset.&quot;&quot;&quot;</span>
        <span class="c1"># Ignore local models.</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignoring_local_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected a single model, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Record.save"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.Record.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenRecord</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the record to disk. Will overwrite any existing file at the same path.&quot;&quot;&quot;</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dill</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FrozenRecord</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span></div></div>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="FrozenRecord"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.FrozenRecord">[docs]</a><span class="k">class</span> <span class="nc">FrozenRecord</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Record container saved on disk.</span>

<span class="sd">    Note that records are saved via pickling and are therefore neither portable nor secure.</span>
<span class="sd">    Only open frozen records generated on the same system.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FrozenRecord.path"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.FrozenRecord.path">[docs]</a>    <span class="n">path</span><span class="p">:</span> <span class="n">Path</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The path to the pickled Record. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FrozenRecord.load"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.FrozenRecord.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Record</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the record into memory.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="FrozenRecord.datasets"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.FrozenRecord.datasets">[docs]</a>    <span class="k">def</span> <span class="nf">datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The known data from the observer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">datasets</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="FrozenRecord.models"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.FrozenRecord.models">[docs]</a>    <span class="k">def</span> <span class="nf">models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The models over the :attr:`datasets`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">models</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="FrozenRecord.acquisition_state"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.FrozenRecord.acquisition_state">[docs]</a>    <span class="k">def</span> <span class="nf">acquisition_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The acquisition state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">acquisition_state</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="FrozenRecord.dataset"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.FrozenRecord.dataset">[docs]</a>    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The dataset when there is just one dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">dataset</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="FrozenRecord.model"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.FrozenRecord.model">[docs]</a>    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProbabilisticModelType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The model when there is just one dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">model</span></div></div>


<span class="c1"># this should be a generic NamedTuple, but mypy doesn&#39;t support them</span>
<span class="c1">#  https://github.com/python/mypy/issues/685</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="OptimizationResult"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult">[docs]</a><span class="k">class</span> <span class="nc">OptimizationResult</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The final result, and the historical data of the optimization process.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OptimizationResult.final_result"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.final_result">[docs]</a>    <span class="n">final_result</span><span class="p">:</span> <span class="n">Result</span><span class="p">[</span><span class="n">Record</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]]</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The final result of the optimization process. This contains either a :class:`Record` or an</span>
<span class="sd">    exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OptimizationResult.history"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.history">[docs]</a>    <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span>
        <span class="n">Record</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]</span> <span class="o">|</span> <span class="n">FrozenRecord</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]</span>
    <span class="p">]</span></div>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The history of the :class:`Record`\ s from each step of the optimization process. These</span>
<span class="sd">    :class:`Record`\ s are created at the *start* of each loop, and as such will never</span>
<span class="sd">    include the :attr:`final_result`. The records may be either in memory or on disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="OptimizationResult.step_filename"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.step_filename">[docs]</a>    <span class="k">def</span> <span class="nf">step_filename</span><span class="p">(</span><span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default filename for saved optimization steps.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;step.</span><span class="si">{</span><span class="n">step</span><span class="si">:</span><span class="s2">0</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num_steps</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="si">}</span><span class="s2">d</span><span class="si">}</span><span class="s2">.pickle&quot;</span></div>

    <span class="n">STEP_GLOB</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;step.*.pickle&quot;</span>
    <span class="n">RESULTS_FILENAME</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;results.pickle&quot;</span>

<div class="viewcode-block" id="OptimizationResult.astuple"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.astuple">[docs]</a>    <span class="k">def</span> <span class="nf">astuple</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">Result</span><span class="p">[</span><span class="n">Record</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]],</span>
        <span class="nb">list</span><span class="p">[</span>
            <span class="n">Record</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">FrozenRecord</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]</span>
        <span class="p">],</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Note:** In contrast to the standard library function :func:`dataclasses.astuple`, this</span>
<span class="sd">        method does *not* deepcopy instance attributes.</span>

<span class="sd">        :return: The :attr:`final_result` and :attr:`history` as a 2-tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="OptimizationResult.is_ok"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.is_ok">[docs]</a>    <span class="k">def</span> <span class="nf">is_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`True` if the final result contains a :class:`Record`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="o">.</span><span class="n">is_ok</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="OptimizationResult.is_err"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.is_err">[docs]</a>    <span class="k">def</span> <span class="nf">is_err</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`True` if the final result contains an exception.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="o">.</span><span class="n">is_err</span></div>

<div class="viewcode-block" id="OptimizationResult.try_get_final_datasets"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.try_get_final_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">try_get_final_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to attempt to get the final data.</span>

<span class="sd">        :return: The final data, if the optimization completed successfully.</span>
<span class="sd">        :raise Exception: If an exception occurred during optimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">datasets</span></div>

<div class="viewcode-block" id="OptimizationResult.try_get_final_dataset"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.try_get_final_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">try_get_final_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to attempt to get the final data for a single dataset run.</span>

<span class="sd">        :return: The final data, if the optimization completed successfully.</span>
<span class="sd">        :raise Exception: If an exception occurred during optimization.</span>
<span class="sd">        :raise ValueError: If the optimization was not a single dataset run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_get_final_datasets</span><span class="p">()</span>
        <span class="c1"># Ignore local datasets.</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">ignoring_local_tags</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected a single dataset, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptimizationResult.try_get_optimal_point"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.try_get_optimal_point">[docs]</a>    <span class="k">def</span> <span class="nf">try_get_optimal_point</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">TensorType</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to attempt to get the optimal point for a single dataset,</span>
<span class="sd">        single objective run.</span>

<span class="sd">        :return: Tuple of the optimal query point, observation and its index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_get_final_dataset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">dataset</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected a single objective&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_any</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">SupportsCovarianceWithTopFidelity</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_get_final_models</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected single fidelity models&quot;</span><span class="p">)</span>
        <span class="n">arg_min_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">query_points</span><span class="p">[</span><span class="n">arg_min_idx</span><span class="p">],</span> <span class="n">dataset</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="n">arg_min_idx</span><span class="p">],</span> <span class="n">arg_min_idx</span></div>

<div class="viewcode-block" id="OptimizationResult.try_get_final_models"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.try_get_final_models">[docs]</a>    <span class="k">def</span> <span class="nf">try_get_final_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to attempt to get the final models.</span>

<span class="sd">        :return: The final models, if the optimization completed successfully.</span>
<span class="sd">        :raise Exception: If an exception occurred during optimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">models</span></div>

<div class="viewcode-block" id="OptimizationResult.try_get_final_model"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.try_get_final_model">[docs]</a>    <span class="k">def</span> <span class="nf">try_get_final_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProbabilisticModelType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to attempt to get the final model for a single model run.</span>

<span class="sd">        :return: The final model, if the optimization completed successfully.</span>
<span class="sd">        :raise Exception: If an exception occurred during optimization.</span>
<span class="sd">        :raise ValueError: If the optimization was not a single model run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_get_final_models</span><span class="p">()</span>
        <span class="c1"># Ignore local models.</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">ignoring_local_tags</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected single model, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="OptimizationResult.loaded_history"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.loaded_history">[docs]</a>    <span class="k">def</span> <span class="nf">loaded_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Record</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The history of the optimization process loaded into memory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">record</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">Record</span><span class="p">)</span> <span class="k">else</span> <span class="n">record</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">]</span></div>

<div class="viewcode-block" id="OptimizationResult.save_result"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.save_result">[docs]</a>    <span class="k">def</span> <span class="nf">save_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the final result to disk. Will overwrite any existing file at the same path.&quot;&quot;&quot;</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dill</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptimizationResult.save"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the optimization result to disk. Will overwrite existing files at the same path.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
        <span class="n">num_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_result</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESULTS_FILENAME</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loaded_history</span><span class="p">):</span>
            <span class="n">record_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_filename</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>
            <span class="n">record</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">record_path</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="OptimizationResult.from_path"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.OptimizationResult.from_path">[docs]</a>    <span class="k">def</span> <span class="nf">from_path</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">base_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a previously saved OptimizationResult.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span> <span class="o">/</span> <span class="bp">cls</span><span class="o">.</span><span class="n">RESULTS_FILENAME</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span>
            <span class="n">Record</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">FrozenRecord</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">ProbabilisticModelType</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">FrozenRecord</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">STEP_GLOB</span><span class="p">))]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BayesianOptimizer"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.BayesianOptimizer">[docs]</a><span class="k">class</span> <span class="nc">BayesianOptimizer</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">SearchSpaceType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class performs Bayesian optimization, the data-efficient optimization of an expensive</span>
<span class="sd">    black-box *objective function* over some *search space*. Since we may not have access to the</span>
<span class="sd">    objective function itself, we speak instead of an *observer* that observes it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observer</span><span class="p">:</span> <span class="n">Observer</span><span class="p">,</span> <span class="n">search_space</span><span class="p">:</span> <span class="n">SearchSpaceType</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param observer: The observer of the objective function.</span>
<span class="sd">        :param search_space: The space over which to search. Must be a</span>
<span class="sd">            :class:`~trieste.space.SearchSpace`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observer</span> <span class="o">=</span> <span class="n">observer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_space</span> <span class="o">=</span> <span class="n">search_space</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;BayesianOptimizer(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_observer</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_space</span><span class="si">!r}</span><span class="s2">)&quot;</span>

    <span class="nd">@overload</span>
<div class="viewcode-block" id="BayesianOptimizer.optimize"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.BayesianOptimizer.optimize">[docs]</a>    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModel</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModel</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">TrainableProbabilisticModel</span><span class="p">]:</span>
        <span class="o">...</span></div>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">],</span>
        <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
            <span class="n">TensorType</span><span class="p">,</span> <span class="n">SearchSpaceType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span>
        <span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModelType</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="c1"># this should really be OptimizationResult[None], but tf.Tensor is untyped so the type</span>
        <span class="c1"># checker can&#39;t differentiate between TensorType and State[S | None, TensorType], and</span>
        <span class="c1"># the return types clash. object is close enough to None that object will do.</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">],</span>
        <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
            <span class="n">TensorType</span><span class="p">,</span> <span class="n">SearchSpaceType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span>
        <span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModelType</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">],</span>
        <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
            <span class="n">State</span><span class="p">[</span><span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">],</span> <span class="n">SearchSpaceType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span>
        <span class="p">],</span>
        <span class="n">acquisition_state</span><span class="p">:</span> <span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModelType</span><span class="p">,</span> <span class="n">StateType</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">],</span>
        <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
            <span class="n">State</span><span class="p">[</span><span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">],</span> <span class="n">SearchSpaceType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span>
        <span class="p">],</span>
        <span class="n">acquisition_state</span><span class="p">:</span> <span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModelType</span><span class="p">,</span> <span class="n">StateType</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">TrainableProbabilisticModel</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModel</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">TrainableProbabilisticModel</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">,</span>
        <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
            <span class="n">TensorType</span><span class="p">,</span> <span class="n">SearchSpaceType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span>
        <span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModelType</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">,</span>
        <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
            <span class="n">TensorType</span><span class="p">,</span> <span class="n">SearchSpaceType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span>
        <span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModelType</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">,</span>
        <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
            <span class="n">State</span><span class="p">[</span><span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">],</span> <span class="n">SearchSpaceType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span>
        <span class="p">],</span>
        <span class="n">acquisition_state</span><span class="p">:</span> <span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModelType</span><span class="p">,</span> <span class="n">StateType</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">,</span>
        <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
            <span class="n">State</span><span class="p">[</span><span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">],</span> <span class="n">SearchSpaceType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span>
        <span class="p">],</span>
        <span class="n">acquisition_state</span><span class="p">:</span> <span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModelType</span><span class="p">,</span> <span class="n">StateType</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]</span> <span class="o">|</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]</span> <span class="o">|</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">,</span>
        <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
            <span class="n">TensorType</span> <span class="o">|</span> <span class="n">State</span><span class="p">[</span><span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">],</span>
            <span class="n">SearchSpaceType</span><span class="p">,</span>
            <span class="n">TrainableProbabilisticModelType</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">acquisition_state</span><span class="p">:</span> <span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">track_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">track_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fit_initial_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stop_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModelType</span><span class="p">,</span> <span class="n">StateType</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="n">OptimizationResult</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]</span>
        <span class="o">|</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to find the minimizer of the ``observer`` in the ``search_space`` (both specified at</span>
<span class="sd">        :meth:`__init__`). This is the central implementation of the Bayesian optimization loop.</span>

<span class="sd">        For each step in ``num_steps``, this method:</span>
<span class="sd">            - Finds the next points with which to query the ``observer`` using the</span>
<span class="sd">              ``acquisition_rule``&#39;s :meth:`acquire` method, passing it the ``search_space``,</span>
<span class="sd">              ``datasets``, ``models``, and current acquisition state.</span>
<span class="sd">            - Queries the ``observer`` *once* at those points.</span>
<span class="sd">            - Updates the datasets and models with the data from the ``observer``.</span>

<span class="sd">        If any errors are raised during the optimization loop, this method will catch and return</span>
<span class="sd">        them instead and print a message (using `absl` at level `absl.logging.ERROR`).</span>
<span class="sd">        If ``track_state`` is enabled, then in addition to the final result, the history of the</span>
<span class="sd">        optimization process will also be returned. If ``track_path`` is also set, then</span>
<span class="sd">        the history and final result will be saved to disk rather than all being kept in memory.</span>

<span class="sd">        **Type hints:**</span>
<span class="sd">            - The ``acquisition_rule`` must use the same type of</span>
<span class="sd">              :class:`~trieste.space.SearchSpace` as specified in :meth:`__init__`.</span>
<span class="sd">            - The ``acquisition_state`` must be of the type expected by the ``acquisition_rule``.</span>
<span class="sd">              Any acquisition state in the optimization result will also be of this type.</span>

<span class="sd">        :param num_steps: The number of optimization steps to run.</span>
<span class="sd">        :param datasets: The known observer query points and observations for each tag.</span>
<span class="sd">        :param models: The model to use for each :class:`~trieste.data.Dataset` in</span>
<span class="sd">            ``datasets``.</span>
<span class="sd">        :param acquisition_rule: The acquisition rule, which defines how to search for a new point</span>
<span class="sd">            on each optimization step. Defaults to</span>
<span class="sd">            :class:`~trieste.acquisition.rule.EfficientGlobalOptimization` with default</span>
<span class="sd">            arguments. Note that if the default is used, this implies the tags must be</span>
<span class="sd">            `OBJECTIVE`, the search space can be any :class:`~trieste.space.SearchSpace`, and the</span>
<span class="sd">            acquisition state returned in the :class:`OptimizationResult` will be `None`.</span>
<span class="sd">        :param acquisition_state: The acquisition state to use on the first optimization step.</span>
<span class="sd">            This argument allows the caller to restore the optimization process from an existing</span>
<span class="sd">            :class:`Record`.</span>
<span class="sd">        :param track_state: If `True`, this method saves the optimization state at the start of each</span>
<span class="sd">            step. Models and acquisition state are copied using `copy.deepcopy`.</span>
<span class="sd">        :param track_path: If set, the optimization state is saved to disk at this path,</span>
<span class="sd">            rather than being copied in memory.</span>
<span class="sd">        :param fit_model: If `False` then we never fit the model during BO (e.g. if we</span>
<span class="sd">            are using a rule that doesn&#39;t rely on the models and don&#39;t want to waste computation).</span>
<span class="sd">        :param fit_initial_model: If `False` then we assume that the initial models have</span>
<span class="sd">            already been optimized on the datasets and so do not require optimization before</span>
<span class="sd">            the first optimization step.</span>
<span class="sd">        :param early_stop_callback: An optional callback that is evaluated with the current</span>
<span class="sd">            datasets, models and optimization state before every optimization step. If this</span>
<span class="sd">            returns `True` then the optimization loop is terminated early.</span>
<span class="sd">        :param start_step: The step number to start with. This number is removed from ``num_steps``</span>
<span class="sd">            and is useful for restarting previous computations.</span>
<span class="sd">        :return: An :class:`OptimizationResult`. The :attr:`final_result` element contains either</span>
<span class="sd">            the final optimization data, models and acquisition state, or, if an exception was</span>
<span class="sd">            raised while executing the optimization loop, it contains the exception raised. In</span>
<span class="sd">            either case, the :attr:`history` element is the history of the data, models and</span>
<span class="sd">            acquisition state at the *start* of each optimization step (up to and including any step</span>
<span class="sd">            that fails to complete). The history will never include the final optimization result.</span>
<span class="sd">        :raise ValueError: If any of the following are true:</span>

<span class="sd">            - ``num_steps`` is negative.</span>
<span class="sd">            - the keys in ``datasets`` and ``models`` do not match</span>
<span class="sd">            - ``datasets`` or ``models`` are empty</span>
<span class="sd">            - the default `acquisition_rule` is used and the tags are not `OBJECTIVE`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy the dataset so we don&#39;t change the one provided by the user.</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="p">{</span><span class="n">OBJECTIVE</span><span class="p">:</span> <span class="n">datasets</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">models</span> <span class="o">=</span> <span class="p">{</span><span class="n">OBJECTIVE</span><span class="p">:</span> <span class="n">models</span><span class="p">}</span>

        <span class="n">filtered_datasets</span> <span class="o">=</span> <span class="n">datasets</span>
        <span class="c1"># reassure the type checker that everything is tagged</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span> <span class="n">datasets</span><span class="p">)</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">],</span> <span class="n">models</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_steps</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num_steps must be at least 0, got </span><span class="si">{</span><span class="n">num_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get set of dataset and model keys, ignoring any local tag index. That is, only the</span>
        <span class="c1"># global tag part is considered.</span>
        <span class="n">datasets_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">LocalizedTag</span><span class="o">.</span><span class="n">from_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">global_tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">models_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">LocalizedTag</span><span class="o">.</span><span class="n">from_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">global_tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">datasets_keys</span> <span class="o">!=</span> <span class="n">models_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;datasets and models should contain the same keys. Got </span><span class="si">{</span><span class="n">datasets_keys</span><span class="si">}</span><span class="s2"> and&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">models_keys</span><span class="si">}</span><span class="s2"> respectively.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dicts of datasets and models must be populated.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">acquisition_rule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="p">{</span><span class="n">OBJECTIVE</span><span class="p">}:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Default acquisition rule EfficientGlobalOptimization requires tag&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">OBJECTIVE</span><span class="si">!r}</span><span class="s2">, got keys </span><span class="si">{</span><span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">acquisition_rule</span> <span class="o">=</span> <span class="n">EfficientGlobalOptimization</span><span class="p">[</span>
                <span class="n">SearchSpaceType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span>
            <span class="p">]()</span>

        <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span>
            <span class="n">FrozenRecord</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">Record</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">history_state</span> <span class="o">=</span> <span class="n">acquisition_state</span>
        <span class="n">query_plot_dfs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">observation_plot_dfs</span> <span class="o">=</span> <span class="n">observation_plot_init</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

        <span class="n">summary_writer</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_tensorboard_writer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">summary_writer</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">summary_writer</span><span class="o">.</span><span class="n">as_default</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">write_summary_init</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_observer</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_search_space</span><span class="p">,</span>
                    <span class="n">acquisition_rule</span><span class="p">,</span>
                    <span class="n">datasets</span><span class="p">,</span>
                    <span class="n">models</span><span class="p">,</span>
                    <span class="n">num_steps</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">set_step_number</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">early_stop_callback</span> <span class="ow">and</span> <span class="n">early_stop_callback</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">acquisition_state</span><span class="p">):</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Optimization terminated early&quot;</span><span class="p">,</span> <span class="n">output_stream</span><span class="o">=</span><span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">track_state</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># note that we use the state as it was at acquisition time, not the one</span>
                        <span class="c1"># modified in filter_datasets in preparation for the next acquisition,</span>
                        <span class="c1"># so we can restart the optimization correctly (and also for plotting)</span>
                        <span class="k">if</span> <span class="n">track_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">datasets_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
                            <span class="n">models_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
                            <span class="n">history_state_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">history_state</span><span class="p">)</span>
                            <span class="n">record</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">datasets_copy</span><span class="p">,</span> <span class="n">models_copy</span><span class="p">,</span> <span class="n">history_state_copy</span><span class="p">)</span>
                            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">track_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">track_path</span><span class="p">)</span>
                            <span class="n">record</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">history_state</span><span class="p">)</span>
                            <span class="n">file_name</span> <span class="o">=</span> <span class="n">OptimizationResult</span><span class="o">.</span><span class="n">step_filename</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>
                            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">track_path</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="s2">&quot;Failed to save the optimization state. Some models do not support &quot;</span>
                            <span class="s2">&quot;deecopying or serialization and cannot be saved. &quot;</span>
                            <span class="s2">&quot;(This is particularly common for deep neural network models, though &quot;</span>
                            <span class="s2">&quot;some of the model wrappers accept a model closure as a workaround.) &quot;</span>
                            <span class="s2">&quot;For these models, the `track_state`` argument of the &quot;</span>
                            <span class="s2">&quot;:meth:`~trieste.bayesian_optimizer.BayesianOptimizer.optimize` method &quot;</span>
                            <span class="s2">&quot;should be set to `False`. This means that only the final model &quot;</span>
                            <span class="s2">&quot;will be available.&quot;</span>
                        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

                <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># See explanation in AskTellOptimizer.__init__().</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acquisition_rule</span><span class="p">,</span> <span class="n">LocalDatasetsAcquisitionRule</span><span class="p">):</span>
                        <span class="n">datasets</span> <span class="o">=</span> <span class="n">with_local_datasets</span><span class="p">(</span>
                            <span class="n">datasets</span><span class="p">,</span> <span class="n">acquisition_rule</span><span class="o">.</span><span class="n">num_local_datasets</span>
                        <span class="p">)</span>
                        <span class="n">acquisition_rule</span><span class="o">.</span><span class="n">initialize_subspaces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_space</span><span class="p">)</span>

                    <span class="n">filtered_datasets_or_callable</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]</span> <span class="o">|</span> <span class="n">State</span><span class="p">[</span>
                        <span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">acquisition_rule</span><span class="o">.</span><span class="n">filter_datasets</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">datasets</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">filtered_datasets_or_callable</span><span class="p">):</span>
                        <span class="n">acquisition_state</span><span class="p">,</span> <span class="n">filtered_datasets</span> <span class="o">=</span> <span class="n">filtered_datasets_or_callable</span><span class="p">(</span>
                            <span class="n">acquisition_state</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">filtered_datasets</span> <span class="o">=</span> <span class="n">filtered_datasets_or_callable</span>

                    <span class="k">if</span> <span class="n">fit_model</span> <span class="ow">and</span> <span class="n">fit_initial_model</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">initial_model_fitting_timer</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="c1"># Prefer local dataset if available.</span>
                                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">,</span> <span class="n">LocalizedTag</span><span class="o">.</span><span class="n">from_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">global_tag</span><span class="p">]</span>
                                <span class="n">_</span><span class="p">,</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_value_for_tag</span><span class="p">(</span><span class="n">filtered_datasets</span><span class="p">,</span> <span class="o">*</span><span class="n">tags</span><span class="p">)</span>
                                <span class="k">assert</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
                                <span class="n">optimize_model_and_save_result</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">summary_writer</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">set_step_number</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="k">with</span> <span class="n">summary_writer</span><span class="o">.</span><span class="n">as_default</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                                <span class="n">write_summary_initial_model_fit</span><span class="p">(</span>
                                    <span class="n">datasets</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">initial_model_fitting_timer</span>
                                <span class="p">)</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">set_step_number</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">total_step_wallclock_timer</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">query_point_generation_timer</span><span class="p">:</span>
                        <span class="n">points_or_stateful</span> <span class="o">=</span> <span class="n">acquisition_rule</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_search_space</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="n">filtered_datasets</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">points_or_stateful</span><span class="p">):</span>
                            <span class="n">acquisition_state</span><span class="p">,</span> <span class="n">query_points</span> <span class="o">=</span> <span class="n">points_or_stateful</span><span class="p">(</span><span class="n">acquisition_state</span><span class="p">)</span>
                            <span class="n">history_state</span> <span class="o">=</span> <span class="n">acquisition_state</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">query_points</span> <span class="o">=</span> <span class="n">points_or_stateful</span>

                    <span class="n">observer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observer</span>
                    <span class="c1"># If query_points are rank 3, then use a batched observer.</span>
                    <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">query_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">observer</span> <span class="o">=</span> <span class="n">mk_batch_observer</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
                    <span class="n">observer_output</span> <span class="o">=</span> <span class="n">observer</span><span class="p">(</span><span class="n">query_points</span><span class="p">)</span>

                    <span class="n">tagged_output</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">observer_output</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observer_output</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
                        <span class="k">else</span> <span class="p">{</span><span class="n">OBJECTIVE</span><span class="p">:</span> <span class="n">observer_output</span><span class="p">}</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">new_dataset</span> <span class="ow">in</span> <span class="n">tagged_output</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">datasets</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_dataset</span>

                    <span class="n">filtered_datasets_or_callable</span> <span class="o">=</span> <span class="n">acquisition_rule</span><span class="o">.</span><span class="n">filter_datasets</span><span class="p">(</span>
                        <span class="n">models</span><span class="p">,</span> <span class="n">datasets</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">filtered_datasets_or_callable</span><span class="p">):</span>
                        <span class="n">acquisition_state</span><span class="p">,</span> <span class="n">filtered_datasets</span> <span class="o">=</span> <span class="n">filtered_datasets_or_callable</span><span class="p">(</span>
                            <span class="n">acquisition_state</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">filtered_datasets</span> <span class="o">=</span> <span class="n">filtered_datasets_or_callable</span>

                    <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_fitting_timer</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fit_model</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="c1"># Always use the matching dataset to the model. If the model is</span>
                                <span class="c1"># local, then the dataset should be too by this stage.</span>
                                <span class="n">dataset</span> <span class="o">=</span> <span class="n">filtered_datasets</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
                                <span class="n">optimize_model_and_save_result</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">summary_writer</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">summary_writer</span><span class="o">.</span><span class="n">as_default</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">):</span>
                        <span class="n">write_summary_observations</span><span class="p">(</span>
                            <span class="n">datasets</span><span class="p">,</span>
                            <span class="n">models</span><span class="p">,</span>
                            <span class="n">tagged_output</span><span class="p">,</span>
                            <span class="n">model_fitting_timer</span><span class="p">,</span>
                            <span class="n">observation_plot_dfs</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">write_summary_query_points</span><span class="p">(</span>
                            <span class="n">datasets</span><span class="p">,</span>
                            <span class="n">models</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_search_space</span><span class="p">,</span>
                            <span class="n">query_points</span><span class="p">,</span>
                            <span class="n">query_point_generation_timer</span><span class="p">,</span>
                            <span class="n">query_plot_dfs</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s2">&quot;wallclock/step&quot;</span><span class="p">,</span> <span class="n">total_step_wallclock_timer</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimization failed at step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">, encountered error with traceback:&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Terminating optimization and returning the optimization history. You may &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;be able to use the history to restart the process from a previous successful &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;optimization step.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">output_stream</span><span class="o">=</span><span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">):</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">One possible cause of memory errors is trying to evaluate acquisition &quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">functions over large datasets, e.g. when initializing optimizers. &quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You may be able to word around this by splitting up the evaluation &quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">using split_acquisition_function or split_acquisition_function_calls.&quot;</span><span class="p">,</span>
                        <span class="n">output_stream</span><span class="o">=</span><span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">OptimizationResult</span><span class="p">(</span><span class="n">Err</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="n">history</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">track_state</span> <span class="ow">and</span> <span class="n">track_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">save_result</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">track_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">OptimizationResult</span><span class="o">.</span><span class="n">RESULTS_FILENAME</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="n">tf</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Optimization completed without errors&quot;</span><span class="p">,</span> <span class="n">output_stream</span><span class="o">=</span><span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="n">record</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">history_state</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">OptimizationResult</span><span class="p">(</span><span class="n">Ok</span><span class="p">(</span><span class="n">record</span><span class="p">),</span> <span class="n">history</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">track_state</span> <span class="ow">and</span> <span class="n">track_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">save_result</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">track_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">OptimizationResult</span><span class="o">.</span><span class="n">RESULTS_FILENAME</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="BayesianOptimizer.continue_optimization"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.BayesianOptimizer.continue_optimization">[docs]</a>    <span class="k">def</span> <span class="nf">continue_optimization</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">optimization_result</span><span class="p">:</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Continue a previous optimization that either failed, was terminated early, or which</span>
<span class="sd">        you simply wish to run for more steps.</span>

<span class="sd">        :param num_steps: The total number of optimization steps, including any that have already</span>
<span class="sd">            been run.</span>
<span class="sd">        :param optimization_result: The optimization result from which to extract the datasets,</span>
<span class="sd">            models and acquisition state. If the result was successful then the final result is</span>
<span class="sd">            used; otherwise the last record in the history is used. The size of the history</span>
<span class="sd">            is used to determine how many more steps are required.</span>
<span class="sd">        :param args: Any more positional arguments to pass on to optimize.</span>
<span class="sd">        :param kwargs: Any more keyword arguments to pass on to optimize.</span>
<span class="sd">        :return: An :class:`OptimizationResult`. The history will contain both the history from</span>
<span class="sd">            `optimization_result` (including the `final_result` if that was successful) and</span>
<span class="sd">            any new records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span>
            <span class="n">Record</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">FrozenRecord</span><span class="p">[</span><span class="n">StateType</span><span class="p">,</span> <span class="n">TrainableProbabilisticModelType</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">history</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">optimization_result</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">optimization_result</span><span class="o">.</span><span class="n">final_result</span><span class="o">.</span><span class="n">is_ok</span><span class="p">:</span>
            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimization_result</span><span class="o">.</span><span class="n">final_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot continue from empty optimization result&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>  <span class="c1"># type: ignore[call-overload]</span>
            <span class="n">num_steps</span><span class="p">,</span>
            <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span>
            <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">models</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="n">acquisition_state</span><span class="o">=</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">acquisition_state</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">start_step</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">history</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="write_summary_init"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.write_summary_init">[docs]</a><span class="k">def</span> <span class="nf">write_summary_init</span><span class="p">(</span>
    <span class="n">observer</span><span class="p">:</span> <span class="n">Observer</span><span class="p">,</span>
    <span class="n">search_space</span><span class="p">:</span> <span class="n">SearchSpace</span><span class="p">,</span>
    <span class="n">acquisition_rule</span><span class="p">:</span> <span class="n">AcquisitionRule</span><span class="p">[</span>
        <span class="n">TensorType</span> <span class="o">|</span> <span class="n">State</span><span class="p">[</span><span class="n">StateType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">],</span>
        <span class="n">SearchSpaceType</span><span class="p">,</span>
        <span class="n">TrainableProbabilisticModelType</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModel</span><span class="p">],</span>
    <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write initial BO loop TensorBoard summary.&quot;&quot;&quot;</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_logical_devices</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Observer: `</span><span class="si">{</span><span class="n">observer</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Number of steps: `</span><span class="si">{</span><span class="n">num_steps</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Number of initial points: &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Search Space: `</span><span class="si">{</span><span class="n">search_space</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Acquisition rule:</span><span class="se">\n\n</span><span class="s2">    </span><span class="si">{</span><span class="n">acquisition_rule</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Models:</span><span class="se">\n\n</span><span class="s2">    </span><span class="si">{</span><span class="n">models</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Available devices: `</span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">device_type</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">devices</span><span class="p">))</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="write_summary_initial_model_fit"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.write_summary_initial_model_fit">[docs]</a><span class="k">def</span> <span class="nf">write_summary_initial_model_fit</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">ProbabilisticModel</span><span class="p">],</span>
    <span class="n">model_fitting_timer</span><span class="p">:</span> <span class="n">Timer</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write TensorBoard summary for the model fitting to the initial data.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.model&quot;</span><span class="p">):</span>
            <span class="c1"># Prefer local dataset if available.</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">,</span> <span class="n">LocalizedTag</span><span class="o">.</span><span class="n">from_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">global_tag</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_value_for_tag</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="o">*</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">model</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
        <span class="s2">&quot;wallclock/model_fitting&quot;</span><span class="p">,</span>
        <span class="n">model_fitting_timer</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="observation_plot_init"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.observation_plot_init">[docs]</a><span class="k">def</span> <span class="nf">observation_plot_init</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialise query point pairplot dataframes with initial observations.</span>
<span class="sd">    Also logs warnings if pairplot dependencies are not installed.&quot;&quot;&quot;</span>
    <span class="n">observation_plot_dfs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_tensorboard_writer</span><span class="p">():</span>
        <span class="n">seaborn_warning</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">include_summary</span><span class="p">(</span><span class="s2">&quot;query_points/_pairplot&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pd</span> <span class="ow">and</span> <span class="n">sns</span><span class="p">):</span>
            <span class="n">seaborn_warning</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">include_summary</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.observations/_pairplot&quot;</span><span class="p">):</span>
                <span class="n">output_dim</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">output_dim</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pd</span> <span class="ow">and</span> <span class="n">sns</span><span class="p">):</span>
                        <span class="n">seaborn_warning</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">output_dim</span><span class="p">)]</span>
                        <span class="n">observation_plot_dfs</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="n">datasets</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">observation_plot_dfs</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s2">&quot;observations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;initial&quot;</span>

        <span class="k">if</span> <span class="n">seaborn_warning</span><span class="p">:</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pairplot TensorBoard summaries require seaborn to be installed.&quot;</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">One way to do this is to install &#39;trieste[plotting]&#39;.&quot;</span><span class="p">,</span>
                <span class="n">output_stream</span><span class="o">=</span><span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">observation_plot_dfs</span></div>


<div class="viewcode-block" id="write_summary_observations"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.write_summary_observations">[docs]</a><span class="k">def</span> <span class="nf">write_summary_observations</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">ProbabilisticModel</span><span class="p">],</span>
    <span class="n">tagged_output</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">],</span>
    <span class="n">model_fitting_timer</span><span class="p">:</span> <span class="n">Timer</span><span class="p">,</span>
    <span class="n">observation_plot_dfs</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write TensorBoard summary for the current step observations.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tagged_output</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.model&quot;</span><span class="p">):</span>
            <span class="n">models</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

        <span class="n">output_dim</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tagged_output</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">output_dim</span><span class="p">):</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span> <span class="k">if</span> <span class="n">output_dim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tagged_output</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.observation</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">/new_observations&quot;</span><span class="p">,</span>
                    <span class="n">tagged_output</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.observation</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">/best_new_observation&quot;</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tagged_output</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.observation</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">/best_overall&quot;</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]),</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">include_summary</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.observations/_pairplot&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">pd</span> <span class="ow">and</span> <span class="n">sns</span> <span class="ow">and</span> <span class="n">output_dim</span> <span class="o">&gt;=</span> <span class="mi">2</span>
        <span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">output_dim</span><span class="p">)]</span>
            <span class="n">observation_new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">tagged_output</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span>
            <span class="p">)</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">observation_new_df</span><span class="p">[</span><span class="s2">&quot;observations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;new&quot;</span>
            <span class="n">observation_plot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">(</span><span class="n">observation_plot_dfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="n">observation_new_df</span><span class="p">),</span>
                <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">hue_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;initial&quot;</span><span class="p">,</span> <span class="s2">&quot;old&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">]</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;initial&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:orange&quot;</span><span class="p">}</span>
            <span class="n">markers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;initial&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="s2">&quot;o&quot;</span><span class="p">}</span>

            <span class="c1"># assume that any OBJECTIVE- or single-tagged multi-output dataset =&gt; multi-objective</span>
            <span class="c1"># more complex scenarios (e.g. constrained data) need to be plotted by the acq function</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">OBJECTIVE</span><span class="p">:</span>
                <span class="n">observation_plot_df</span><span class="p">[</span><span class="s2">&quot;observation type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observation_plot_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;observations&quot;</span><span class="p">],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">observation_plot_df</span><span class="p">[</span><span class="s2">&quot;pareto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_dominated</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">observations</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">observation_plot_df</span><span class="p">[</span><span class="s2">&quot;observation type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observation_plot_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;observations&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;pareto&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="s2">&quot; (non-dominated)&quot;</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">hue_order</span> <span class="o">+=</span> <span class="p">[</span><span class="n">hue</span> <span class="o">+</span> <span class="s2">&quot; (non-dominated)&quot;</span> <span class="k">for</span> <span class="n">hue</span> <span class="ow">in</span> <span class="n">hue_order</span><span class="p">]</span>
                <span class="n">palette</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;initial (non-dominated)&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:purple&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;old (non-dominated)&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:purple&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;new (non-dominated)&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">markers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;initial (non-dominated)&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;old (non-dominated)&quot;</span><span class="p">:</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;new (non-dominated)&quot;</span><span class="p">:</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="n">pairplot</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span>
                <span class="n">observation_plot_df</span><span class="p">,</span>
                <span class="nb">vars</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;observation type&quot;</span><span class="p">,</span>
                <span class="n">hue_order</span><span class="o">=</span><span class="n">hue_order</span><span class="p">,</span>
                <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span>
                <span class="n">markers</span><span class="o">=</span><span class="n">markers</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.observations/_pairplot&quot;</span><span class="p">,</span> <span class="n">pairplot</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">observation_plot_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">observation_plot_df</span><span class="p">[</span><span class="s2">&quot;observations&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;new&quot;</span><span class="p">,</span> <span class="s2">&quot;observations&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;old&quot;</span>
            <span class="n">observation_plot_dfs</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">observation_plot_df</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
        <span class="s2">&quot;wallclock/model_fitting&quot;</span><span class="p">,</span>
        <span class="n">model_fitting_timer</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="write_summary_query_points"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.write_summary_query_points">[docs]</a><span class="k">def</span> <span class="nf">write_summary_query_points</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">ProbabilisticModel</span><span class="p">],</span>
    <span class="n">search_space</span><span class="p">:</span> <span class="n">SearchSpace</span><span class="p">,</span>
    <span class="n">query_points</span><span class="p">:</span> <span class="n">TensorType</span><span class="p">,</span>
    <span class="n">query_point_generation_timer</span><span class="p">:</span> <span class="n">Timer</span><span class="p">,</span>
    <span class="n">query_plot_dfs</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write TensorBoard summary for the current step query points.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">query_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">query_points</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;query_point/[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">query_points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;query_points/[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">query_points</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="s2">&quot;query_points/euclidean_distances&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">pdist</span><span class="p">(</span><span class="n">query_points</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pd</span> <span class="ow">and</span> <span class="n">sns</span> <span class="ow">and</span> <span class="n">logging</span><span class="o">.</span><span class="n">include_summary</span><span class="p">(</span><span class="s2">&quot;query_points/_pairplot&quot;</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">query_points</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">qp_preds</span> <span class="o">=</span> <span class="n">query_points</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">query_points</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">qp_preds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">qp_preds</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">query_points</span><span class="o">.</span><span class="n">dtype</span><span class="p">)],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">output_dim</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pred</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">output_dim</span><span class="p">):</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}{</span><span class="n">i</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">output_dim</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> predicted&quot;</span><span class="p">)</span>
        <span class="n">query_new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">qp_preds</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">query_new_df</span><span class="p">[</span><span class="s2">&quot;query points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;new&quot;</span>
        <span class="n">query_plot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">(</span><span class="n">query_plot_dfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">query_new_df</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">pairplot</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span>
            <span class="n">query_plot_df</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;query points&quot;</span><span class="p">,</span> <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;old&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="mf">2.25</span>
        <span class="p">)</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="mf">0.025</span> <span class="o">*</span> <span class="p">(</span><span class="n">search_space</span><span class="o">.</span><span class="n">upper</span> <span class="o">-</span> <span class="n">search_space</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
        <span class="n">upper_limits</span> <span class="o">=</span> <span class="n">search_space</span><span class="o">.</span><span class="n">upper</span> <span class="o">+</span> <span class="n">padding</span>
        <span class="n">lower_limits</span> <span class="o">=</span> <span class="n">search_space</span><span class="o">.</span><span class="n">lower</span> <span class="o">-</span> <span class="n">padding</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">search_space</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
            <span class="n">pairplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lower_limits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">upper_limits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">pairplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">lower_limits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">upper_limits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="s2">&quot;query_points/_pairplot&quot;</span><span class="p">,</span> <span class="n">pairplot</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">query_plot_df</span><span class="p">[</span><span class="s2">&quot;query points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;old&quot;</span>
        <span class="n">query_plot_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_plot_df</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
        <span class="s2">&quot;wallclock/query_point_generation&quot;</span><span class="p">,</span>
        <span class="n">query_point_generation_timer</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="stop_at_minimum"><a class="viewcode-back" href="../../autoapi/trieste/bayesian_optimizer/index.html#trieste.bayesian_optimizer.stop_at_minimum">[docs]</a><span class="k">def</span> <span class="nf">stop_at_minimum</span><span class="p">(</span>
    <span class="n">minimum</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">minimizers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">minimum_atol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">minimum_rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">minimizers_atol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">minimizers_rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">objective_tag</span><span class="p">:</span> <span class="n">Tag</span> <span class="o">=</span> <span class="n">OBJECTIVE</span><span class="p">,</span>
    <span class="n">minimum_step_number</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EarlyStopCallback</span><span class="p">[</span><span class="n">TrainableProbabilisticModel</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate an early stop function that terminates a BO loop when it gets close enough to the</span>
<span class="sd">    given objective minimum and/or minimizer points.</span>

<span class="sd">    :param minimum: Optional minimum to stop at, with shape [1].</span>
<span class="sd">    :param minimizers: Optional minimizer points to stop at, with shape [N, D].</span>
<span class="sd">    :param minimum_atol: Absolute tolerance for minimum.</span>
<span class="sd">    :param minimum_rtol: Relative tolerance for minimum.</span>
<span class="sd">    :param minimizers_atol: Absolute tolerance for minimizer point.</span>
<span class="sd">    :param minimizers_rtol: Relative tolerance for minimizer point.</span>
<span class="sd">    :param objective_tag: The tag for the objective data.</span>
<span class="sd">    :param minimum_step_number: Minimum step number to stop at.</span>
<span class="sd">    :return: An early stop function that terminates if we get close enough to both the minimum</span>
<span class="sd">        and any of the minimizer points.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">early_stop_callback</span><span class="p">(</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span>
        <span class="n">_models</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tag</span><span class="p">,</span> <span class="n">TrainableProbabilisticModel</span><span class="p">],</span>
        <span class="n">_acquisition_state</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">minimum_step_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_step_number</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minimum_step_number</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">objective_tag</span><span class="p">]</span>
        <span class="n">arg_min_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">minimum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">best_y</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="n">arg_min_idx</span><span class="p">]</span>
            <span class="n">close_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">best_y</span><span class="p">,</span> <span class="n">minimum</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">minimum_atol</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">minimum_rtol</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_all</span><span class="p">(</span><span class="n">close_y</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">minimizers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">best_x</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">query_points</span><span class="p">[</span><span class="n">arg_min_idx</span><span class="p">]</span>
            <span class="n">close_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">best_x</span><span class="p">,</span> <span class="n">minimizers</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">minimizers_atol</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">minimizers_rtol</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_any</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_all</span><span class="p">(</span><span class="n">close_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">early_stop_callback</span></div>
</pre></div>

                </article>
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright Copyright 2020 The Trieste Contributors

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.1.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>